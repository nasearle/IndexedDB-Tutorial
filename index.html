<!doctype html>
<html>
<head>
	<script type="text/javascript" src =
	"http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
	<script type="text/javascript" src ="idb.js"></script>
</head>

<body>

<h2>Add Person</h2>
<input type="text" id="name" placeholder="Name"><br/>
<input type="email" id="email" placeholder="Email"><br/>
<button id="addPerson">Add Person</button>
<p/>

<h2>Search People</h2>
Starting with: <input type="text" id="lower"><br/>
Ending with: <input type="text" id="upper"><br/>
<button id="search">Search</button>

<div id="results"></div>

<script>
function idbOK() {
	return "indexedDB" in window;
}

$(document).ready(function() {
	if(!idbOK()) return;

	dbPromise = idb.open("test-db6", 1, function(upgradeDb) {
		if (!upgradeDb.objectStoreNames.contains("people")) {
			var peopleOS = upgradeDb.createObjectStore("people", {keyPath: "email"});
			peopleOS.createIndex('name', 'name');
		}
	});

	$("#addPerson").on("click", addPerson);
	$("#search").on("click", searchPeople);
});

function addPerson() {
	var name = $("#name").val();
	var email = $("#email").val();
	console.log("About to add "+name+"/"+email);

	dbPromise.then(function(db) {
		var tx = db.transaction(["people"],"readwrite");
		var store = tx.objectStore("people");
		var person = {
			name:name,
			email:email,
			created:new Date().getTime()
		}
		store.add(person);
		return tx.complete;
	}).then(function() {
		console.log("added person to the people os!");
	});
}

function searchPeople() {
	var lower = $("#lower").val();
	var upper = $("#upper").val();
	if(lower == "" && upper == "") return;

	var range;
	if(lower != "" && upper != "") {
		range = IDBKeyRange.bound(lower, upper);
	} else if(lower == "") {
		range = IDBKeyRange.upperBound(upper);
	} else {
		range = IDBKeyRange.lowerBound(lower);
	}
	var s = "";

	dbPromise.then(function(db) {
		var tx = db.transaction(["people"],"readonly");
		var store = tx.objectStore("people");
		var index = store.index("name");
		return index.openCursor(range);
	}).then(function showRange(cursor) {
		if (!cursor) return;
		console.log("Cursored at:", cursor.value.name);

		s += "<h2>Key "+cursor.key+"</h2><p>";
		for(var field in cursor.value) {
			s+= field+"="+cursor.value[field]+"<br/>";
		}
		s+="</p>";

		return cursor.continue().then(showRange)
	}).then(function() {
	  console.log('Done cursoring');
		if(s === "") s = "<p>No results.</p>";
		$("#results").html(s);
	});
}
</script>
</body>
</html>
