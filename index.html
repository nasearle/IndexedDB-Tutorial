<!doctype html>
<html>
<head>
	<script type="text/javascript" src =
	"http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
	<script type="text/javascript" src="idb.js"></script>
</head>

<body>

<h2>Add Person</h2>
<input type="text" id="name" placeholder="Name"><br/>
<input type="email" id="email" placeholder="Email"><br/>
<button id="addPerson">Add Person</button>

<h2>Add Note</h2>
<textarea id="note"></textarea>
<button id="addNote">Add Note</button>

<h2>Get Person</h2>
<input type="text" id="getemail"> <button id="getPerson">Get Person</button>

<h2>Get Note</h2>
<input type="text" id="getnote"> <button id="getNote">Get Note</button><!doctype html>

<script>
function idbOK() {
	return "indexedDB" in window;
}
var db;
$(document).ready(function() {
	if(!idbOK()) return;

	dbPromise = idb.open("testdb5", 1, function(upgradeDB) {
		var peopleOS = upgradeDB.createObjectStore("people", {keyPath: "email"});
		var notesOS = upgradeDB.createObjectStore("notes", {autoIncrement:true});
	});

	//Start listening for button clicks
	$("#addPerson").on("click", addPerson);
	$("#addNote").on("click", addNote);
	$("#getPerson").on("click", getPerson);
	$("#getNote").on("click", getNote);
});

function addPerson() {
	var name = $("#name").val();
	var email = $("#email").val();
	console.log("About to add "+name+"/"+email);

	dbPromise.then(function(db) {
		//Get a transaction
		//default for OS list is all, default for type is read
		var tx = db.transaction(["people"],"readwrite");
		//open the objectStore on the transaction object
		var store = tx.objectStore("people");
		//Define a person
		var person = {
			name:name,
			email:email,
			created:new Date().getTime()
		}
		//Perform the add
		store.add(person);
		return tx.complete;
	}).then(function() {
		console.log("added person to the people os!");
	});
}

function addNote(e) {
	var note = $("#note").val();
	console.log("About to add "+note);

	dbPromise.then(function(db) {
		//Get a transaction
		//default for OS list is all, default for type is read
		var tx = db.transaction(["notes"],"readwrite");
		//open the objectStore on the transaction object
		var store = tx.objectStore("notes");
		//Define a note
		var note = {
			text:note,
			created:new Date().getTime()
		}
		//Perform the add
		store.add(note);
		return tx.complete;
	}).then(function() {
		console.log("added note to notes os!");
	});
}

function getPerson() {
	var key = $("#getemail").val();
	if(key === "") return;
	dbPromise.then(function(db) {
		var tx = db.transaction(["people"],"readonly");
		var store = tx.objectStore("people");
		return store.get(key);
	}).then(function(val) {
		console.dir(val);
	});
}

function getNote() {
	var key = $("#getnote").val();
	if(key === "") return;
	dbPromise.then(function(db) {
		var tx = db.transaction(["notes"],"readonly");
		var store = tx.objectStore("notes");
		return store.get(Number(key));
	}).then(function(val) {
		console.dir(val);
	});
}
</script>
</body>
</html>
