<!doctype html>
<html>
<head>
	<script type="text/javascript" src =
	"http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
	<script type="text/javascript" src="idb.js"></script>
</head>

<body>
<h2>Get Person</h2>
<input type="text" id="getemail"> <button id="getPerson">Get Person</button>
<p/>

<input type="text" id="name" placeholder="Name"><br/>
<input type="email" id="email" placeholder="Email"><br/>
<input type="hidden" id="created">
<button id="updatePerson">Update Person</button>

<script>
function idbOK() {
	return "indexedDB" in window;
}

$(document).ready(function() {
	if(!idbOK()) return;

	dbPromise = idb.open("test-db5", 1, function(upgradeDb) {
		if (!upgradeDb.objectStoreNames.contains("people")) {
			var peopleOS = upgradeDb.createObjectStore("people", {keyPath: "email"});
		}
		if (!upgradeDb.objectStoreNames.contains("notes")) {
			var notesOS = upgradeDb.createObjectStore("notes", {autoIncrement:true});
		}
	});

	//Start listening for button clicks
	$("#getPerson").on("click", getPerson);
	$("#updatePerson").on("click", updatePerson);

});

function getPerson() {
	var key = $("#getemail").val();
	if(key === "") return;

	dbPromise.then(function(db) {
		var tx = db.transaction(["people"],"readonly");
		var store = tx.objectStore("people");
		return store.get(key);
	}).then(function(val) {
		console.dir(val);
		$("#name").val(val.name);
		$("#email").val(val.email);
		$("#created").val(val.created);
	});
}

function updatePerson() {
	var name = $("#name").val();
	var email = $("#email").val();
	var created = $("#created").val();
	console.log("About to update "+name+"/"+email);

	dbPromise.then(function(db) {
		var tx = db.transaction(["people"],"readwrite");
		var store = tx.objectStore("people");
		var person = {
			name:name,
			email:email,
			created:created
		}
		//Perform the update
		store.put(person);
		return tx.complete;
	}).then(function() {
		console.log('person updated!');
	});
}
</script>
</body>
</html>
